# Коллекция
## Общее описание

Коллекция - тип данных, который хранит в себе ссылки на другие объекты. Данные объекты могут быть объектами исходного класса, если коллекция ссылается на класс, в котором определяется данная коллекция. Например, класс "Монитор" может содержать ссылку "С данной элетронникой также покупают" на класс "Электроника". Класс "Электроника" является родительским классом по отношению к классу "Монитор", поэтому ссылка "С данной элетронникой также покупают" может содержать объекты класса "Монитор". Каждая ссылка содержит значение идентификатора объекта. Идентификаторы объектов определяются ключем в мете класса-коллекции, в данном случае в классе "Электроника". Переопределять ключ в классе "Монитор" нельзя.  
Разделяются ссылки через запятую. Все значение из последовательности ссылок и запятых хранится строкой в базе.

**При указании класса-родителя есть возможность создавать объекты родительского и дочерних классов**

**Коллекции вместе с объектом грузятся по семантике, заданной в мете класса-коллекции или атрибута-коллекции.**

### Способы задания коллекций с точки зрения используемых полей атрибутивной части меты классов:
1. `один-ко-многим` - есть контейнер, есть вложенный объект со ссылкой на контейнер. в контейнере объявляем коллекцию, у нее указываем ссылочный атрибут вложенного объекта по которому формируется связь. __См. Обратные ссылки в контексте коллекций.__ 
2. `многие-ко-многим` - никаких ссылок нет, просто определяем коллекцию, и указываем класс вложенных элементов - связи создаются явно при помещении в коллекцию и хранятся как отдельные сущности в БД. __См. Коллекции.__
3. `обратная коллекция` - когда коллекция многие ко многим задается на основании коллекции в другом объекте. т.е. другая сторона связи задается через *backColl* __См. Обратные коллекции.__
4. `экзотический вариант` - многие-ко-многим через ссылку. когда связь выполняется по не ключевому полю контейнера. т.е. это категоризация. *Например* у региона есть атрибут "уровень преступности" задаваемый в баллах. И есть например сущность "Оперативные мероприятия" с атрибутом "уровень преступности" в баллах - т.е. какие мероприятия при каком уровне преступности проводятся. Заведя в регион коллекцию "Мероприятия" связывающую регион с оперативными мероприятиями по уровню преступности, получаем в регионе коллекцию соответствующих ему мероприятий. __См. Вычислимые коллекции__ (пока нет).

## Атрибут "Таблица" в формате JSON (мета атрибута-коллекции)

Пример

```
{
      "orderNumber": 50,
      "name": "table",
      "caption": "Таблица",
      "type": 14,
      "size": null,
      "decimals": 0,
      "allowedFileTypes": null,
      "maxFileCount": 0,
      "nullable": true,
      "readonly": false,
      "indexed": false,
      "unique": false,
      "autoassigned": false,
      "hint": null,
      "defaultValue": null,
      "refClass": "",
      "itemsClass": "collRefCatalog@develop-and-test",
      "backRef": "",
      "backColl": "",
      "binding": "",
      "semantic": null,
      "selConditions": [],
      "selSorting": [],
      "selectionProvider": null,
      "indexSearch": false,
      "eagerLoading": false,
      "formula": null
    }
```  

### *Обязательно* 
- `"type": 14` - тип атрибута "Коллекция"
- `"itemsClass"` - название класса, объекты которого могут хранить свои идентификаторы в коллекции и, таким образом, формировать привязанные объекты к коллеции.  

[Пример класса, содержащего коллекцию] (http://dev.dnt.local/registry/develop-and-test@classColl.classColl)

# Обратная ссылка в контексте коллекций
## Отличие от обычной коллекции

Обратная ссылка в контексте коллекций получается следующим образом:
- Создается обычная коллекций с указанием ссылочного класса
- В ссылочном классе должен быть атрибут-ссылка, ссылающийся на исходный класс и имеющий свойство `unique` равным `false` . Значение в атрибут-ссылку присваивается сразу при создании связи с коллекцией, без необходимости сохранения формы
- В исходном классе в обычной коллекции заполняем свойство `"backRef"` - туда записывается код атрибута-ссылки из ссылочного класса

## Атрибут "Обратная ссылка" в формате JSON (мета атрибута обратной ссылки в контексте коллекций)

Пример

```
{
      "orderNumber": 30,
      "name": "coll",
      "caption": "Коллекция с обратной ссылкой",
      "type": 14,
      "size": null,
      "decimals": 0,
      "allowedFileTypes": null,
      "maxFileCount": 0,
      "nullable": true,
      "readonly": false,
      "indexed": false,
      "unique": false,
      "autoassigned": false,
      "hint": null,
      "defaultValue": null,
      "refClass": null,
      "itemsClass": "ref_backcoll_ref@develop-and-test",
      "backRef": "ref_backcoll_ref",
      "backColl": "",
      "binding": "",
      "semantic": "backcoll_data",
      "selConditions": [],
      "selSorting": [],
      "selectionProvider": null,
      "indexSearch": false,
      "eagerLoading": true,
      "formula": null
    }
```  

### *Обязательно* 
- `"type": 14` - тип атрибута "Коллекция"
- `"itemsClass"` - название класса, объекты которого могут хранить свои идентификаторы в коллекции и, таким образом, формировать связь к объекту по идентификатору.
- `"backRef"` - атрибута-ссылка из ссылочного класса, указанного в `"itemsClass"`

[Пример класса, содержащего обратную ссылку в контексте коллекций] (http://dev.dnt.local/registry/develop-and-test@classRef.backcoll.refBackcollBackcoll)

# Обратная коллекция
## Отличие от обычной коллекции

Пример коллекции выше преобразуется для обратной коллекции таким образом

```
{
      "orderNumber": 30,
      "name": "backcoll",
      "caption": "Обратная коллекции",
      "type": 14,
      "size": null,
      "decimals": 0,
      "allowedFileTypes": null,
      "maxFileCount": 0,
      "nullable": true,
      "readonly": false,
      "indexed": false,
      "unique": false,
      "autoassigned": false,
      "hint": null,
      "defaultValue": null,
      "refClass": "",
      "itemsClass": "coll_backcoll_coll",
      "backRef": "",
      "backColl": "coll",
      "binding": "",
      "semantic": "backcoll_data",
      "selConditions": [],
      "selSorting": [],
      "selectionProvider": null,
      "indexSearch": false,
      "eagerLoading": true,
      "formula": null
    }
```

Первое отличие, которое сразу видно, это указание в свойстве `"backColl"`: дополнительного значения - имя атрибута из класса в коллекции (из примера это coll). 

Таким образом, реализуется связь многие-ко-многим без промежуточного класса (не только атрибут "backcoll" с типом "Коллекция" может содержать несколько ссылок, но и эти объекты по ссылкам также могут содержать в своей коллекции "coll" несколько ссылок на объекты исходного класса).

### *Обязательно*
- `"type": 14`
- `"itemsClass"`
- `"backColl"` - название ссылочного атрибута типа коллеции, ссылающегося на исходный класс с коллекцией.

[Пример класса, содержащего обратную коллекцию] (http://dev.dnt.local/registry/develop-and-test@classColl.backcoll.collBackcollBackcoll)

## Схема обработки коллекций и формат их хранения в БД
Для сохранения коллекции, надо передать в соответствующем ей атрибуте объекта массив действий вида:
```
"collection": [
  {"action": "put", "id": "1234"},
  {"action": "put", "id": "1235"},
  {"action": "put", "id": "1236"},
  {"action": "eject", "id": "1230"}
]
```
Порядок объектов должен соответствовать порядку выполнения соответствующих действий. Коды операций: `put` - добавление в коллекцию, `eject` - извлечение из коллекции. "Вычищать" действия над одним и тем же объектом не нужно, контроллер воспримет только последнее действие.
Алгоритм для создания и редактирования одинаков. Действия с коллекциями выполняются после создания или сохранения контейнера.

Логика работы коллекций на форме создания и редактирования принципиально разная: 
* На форме создания взаимодействие с сервером требуется лишь для получения и отображения в таблице выбранного/созданного объекта коллекции
* На форме редактирования реализована возможность получения ответа сервера при необходимости, и изменение параметров выборки при запросе, в зависимости от выполненных действий над коллекцией.

## Пример реализации
Режимы отображения данных для атрибутов типа "Коллекция": http://dev.dnt.local/registry/develop-and-test@classColl.classColl

### Следующая страница []()
--------------------------------------------------------------------------  


 #### [Licence](/LICENCE.md) &ensp;  [Contact us](https://iondv.com) &ensp;  [English](/README.md)   &ensp; [FAQs](/faqs.md)          



--------------------------------------------------------------------------  

Copyright (c) 2018 **LLC "ION DV"**.
All rights reserved. 