# Фильтры при открытии списка объектов (реестрозависимо!)

## Сохраненные фильтры
Перед открытием любой страницы в реестрах происходит считывание фильтров которые подходят для данного окна. Подходящие фильтры состоят из двух частей:
1. Общие фильтры, которые применимы для всех классов
2. Фильтры сохраненные конкретно для данного класса.

### Общие фильтры для всех классов
Как следует из названия это фильтры, которые отображаются для всех открываемых классов. В чем их принципиальное отличие в коде? В атрибуте класс у общего фильтра стоит ключевое слово ALL, у персональных фильтров в этом атрибуте стоит название класса, для которого он применим.
Чтобы сделать фильтр для всех классов нужно выставить при сохранении галку "Для всех классов"
### Фильтры для конкретных классов
чтобы создать фильтр для конкретного класса, нужно открыть объекты этого класса, сгенерировать фильтр и сохранить его убедившись, что галка "Для всех классов" - пуста.

### Принцип и реализация в коде
Реализована единая спецификация выражений, как для вычисляемых выражений, так и для условий отбора и расчетов в агрегации.

Большая часть работы берется файлом _list-filter-ui - именно он запускает поиск нужных фильтров, а также разбирает текущие данные для создания новых фильтров. 
В нем описана логика какие атрибуты могут участвовать в создании фильтров и как именно они должны выглядеть и сохраняться ( например дата и чекбокс выглядят по разному)

Также важной частью работы с фильтрами является параметр cond, который в итоге передается на обработку. именно в нем находятся данные фильтра, которые в последствие подставляются в условие для поиска ( это все происходит в файле _metaCRUD.js) 
```
        if (cond !== undefined && cond !== '' && cond !== 'undefined') {
          var condObj = JSON.parse(cond);
          if (Array.isArray(condObj) && condObj.length > 0) {
            for (var k = 0; k < condObj.length; k++) {
              if (condObj[k].type === 6) {
                condObj[k].value = new Date(condObj[k].value);
              }
              where[condObj[k].property] = getwherebyOperation(condObj[k]);
            }
          }
        }
```
Стоит сказать, что недавно появились два новых фильтра min, max - https://ion-dv.atlassian.net/browse/IONPORTAL-275. это дало простор для создания фильтров и условий в меню
Но для работы этого функционала были внесены изменения в файл ContentModelMongoDB
### Необходимая мета
Необходимая мета для работы это класс фильтров ion_filter. Лежит он в папке calc, которая по умолчанию является папкой с классами и метой для системы. Кроме одного класса ничего более не нужно.

## Поиск по ссылочным объектам
Совсем недавно появился поиск по ссылочным объектам. У него есть особенность в логике работы. Если поиск идет по принципу равно или содержит - то ищется в семантике этого объекта. Если поиск идет по принципу - максимум/минимум - то ищем уже значение поля. 
```
[{property:okatoNasPunkta_title,operation:20,value:Лес,title:Населенный пункт содержит Лес,type:2}]
```
этот фильтр будет искать Лес в атрибуте okatoNasPunkta_title, и найдет (п Лесной). Тогда как в атрибуте okatoNasPunkta содержится только ссылочное значение 08409000000

Таким образом есть возможность поиска в ссылочных атрибутах, при этом без лишних запросов к базе, что конечно классно в смысле производительности.

# Фильтры в меню. 
Есть возможность не только выдавать отсортированные данные в списке из условий меню, но и ограничивать выборки, т.е. по сути применять фильтры. Как это работает

## Мета отвечающая за работу фильтров
Пример меню с фильтром
```
{
  "code": "passportObject.naselenie",
  "type": 1,
  "orderNumber": 10,
  "caption": "Население",
  "classname": "naselenie",
  "container": null,
  "collection": null,
  "conditions": [
  {"property": "god"
  ,"operation": 10}
  ],
  "sorting": [],
  "pathChains": []
}
```

вроде обычное меню, но здесь интересен атрибут conditions. он содержит два объекта 
1. property  свойство, по которому будем фильтроваться
2. operation - операция фильтрации
В данном случае этот фильтр имеет такой смысл : покажи все объекты класса naselenie с минимальным годом

Если нужно указать значение, то третьим атрибутом пойдет value и значение для поиска. например 
```
{"property": "god"
  ,"operation": 0
, "value": 2015}
```

## Настройка фильтра для отображения объектов класса-наследника

В случаях, когда страницей класса для узла навигации является родительский класс, а отображать на форме представления списка, при переходе по данной навигации, необходимо объекты класса наследника данного класса ( [подробнее о наследовании] (https://git.iondv.ru/ION/platform/wikis/metadata/ancestor) ), применяется фильтр вида:

```
{
   property: "atr1.__class",
   operation: 0,
   value: ["childClass@ns"]
}
```

где, `atr1.__class` - атрибут родительского класса, по которому идет выборка объектов, `childClass` - наследник, объекты которого отображаются в навигации. То есть - *показать на форме списка только те объекты, у которых атрибут `atr1` является объектом класса-наследника `childClass`*


## Таблица операций
| Поле                 | Наименование в студии        | Допустимые значения                                                   | Описание                                                                                           |
|:---------------------|:-----------------------------|:----------------------------------------------------------------------|:---------------------------------------------------------------------------------------------------|
| `"property"`         | **Атрибут**                  | Строка, только латиница без пробелов                                  | Атрибут класса, значение поля которого проверяется на соответствие данному условию данного вектора |
| `"operation"`        | **Операция**                 | Код операции                                                          | Операция, согласно которой производится определение                                                |
|                      |                              | _0 - равно (И)_                                                       |                                                                                                    |
|                      |                              | _1 - не равно (ИЛИ)_                                                  |                                                                                                    |
|                      |                              | _2 - пусто (НЕ)_                                                      |                                                                                                    |
|                      |                              | _3 - не пусто (МИН ИЗ)_                                               |                                                                                                    |
|                      |                              | _4 - (МАКС ИЗ)_                                                       |                                                                                                    |
|                      |                              | _5 - < ()_                                                            |                                                                                                    |
|                      |                              | _6 - >_                                                               |                                                                                                    |
|                      |                              | _7 - <=_                                                              |                                                                                                    |
|                      |                              | _8 - >=_                                                              |                                                                                                    |
|                      |                              | _9 - IN /Похож/_                                                                   |                                                                                                    |
|                      |                              | _10 - содержит_                                                       |                                                                                                    |
| `"value"`            | **Значение**                 | Зависит от типа операции                                              | Второе значение для бинарных операций                                                              |
| `"nestedConditions"` | **Вложенные условия отбора** | Объект, структура аналогична структуре самого объекта условий отбора. |                                                                                                    |

_NB: Код операции соответствует разным значениям операций, в зависимостри от того, выбран у нас атрибут или нет. Если поле  `"property"` равно `null`, то кодируется логическое условие, по которому объединяются вложенные условия отбора! (Указаны в скобках в таблице выше)_

#### Операции для дат

| код | значение | системное имя |
| -------- | -------- | -------- |
|8| Создаем дату |  DATE | 
|9| Добавляем к дате интервал | DATEADD |
|10|  Находим интервал между датами | DATEDIFF |

Аргументы `DATEADD`: _дата, интервал, ед.изм интервала [ms, s, min, h, d, m, y] (по умолчанию - день(d))_

Аргументы `DATEDIFF`: _конечная дата, начальная дата, ед. изм. результата [ms, s, min, h, d, m, y] (по умолчанию - день(d)), логический флаг приведения к целому числу_


## Вызов фильтра
Даже если в меню нет фильтра его можно задать добавив в строку параметр cond


Покажи список с классом khv-svyaz-info_naselenie
http://localhost:3000/reestr/models/reestr-list?cls=khv-svyaz-info_naselenie


Покажи список с классом khv-svyaz-info_naselenie у которых год максимальный
http://localhost:3000/reestr/models/reestr-list?cls=khv-svyaz-info_naselenie&cond=[{%22property%22:%22god%22,%22operation%22:9}]

