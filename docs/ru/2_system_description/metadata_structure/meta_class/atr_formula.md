### Предыдущая страница: [Жадная загрузка](/docs/ru/2_system_description/metadata_structure/meta_class/eager_loading.md) 
# Вычисляемые поля 
## Описание
**Вычисляемые атрибуты** - применяются для вычисления значений по формуле для отображения результата в виде значений поля атрибута.  

Вычисляемые атрибуты настраивают механизм формирования формул, которые вычисляются при открытии формы. При закрытии они сохраняются и их можно использовать как для других формул, так и для ссылочных полей. Также может быть реализовано в семантике. 

Чтобы в поле отобразилось вычисление, необходимо задать значение в свойстве `formula`. При значение `Null` вычесления не будут реализованы. 

# Модель записи формулы (TODO)

Общая модель формул:

* операнды
* слова начинающиеся с $ - сюда подставляются значения поля, если есть операнд разыменования (операция переход по ссылке) `.` - то значит из связанного объекта, пример $person.user
* слова начинающиеся с $$ - поля начинающиеся с $ - т.к. формуле передается контекст - в общем случае объект соответствующий спецификации, как правило передается объект с атрибутами $uid, $context и свойствами `properties` из профиля ($employee, $organization). В $context пишется item. Если атрибут не находится в корне контекста, он рекурсивно ищется в $context. все это с учетом разыменования.
* остальное определяется как обычные строки

### Пример применения формулы:

```
{
      "orderNumber": 5,
      "name": "addressString",
      "caption": "",
      "type": 0,
      "size": null,
      "decimals": 0,
      "allowedFileTypes": null,
      "maxFileCount": 0,
      "nullable": true,
      "readonly": false,
      "indexed": true,
      "unique": false,
      "autoassigned": false,
      "hint": null,
      "defaultValue": null,
      "refClass": "",
      "itemsClass": "",
      "backRef": "",
      "backColl": "",
      "binding": "",
      "semantic": null,
      "selConditions": [],
      "selSorting": [],
      "selectionProvider": null,
      "indexSearch": false,
      "eagerLoading": false,
      "formula": {
        "concat": [
          {
            "if": [
              "$zipCode",
              {
                "concat": [
                  "$zipCode"
                ]
              },
              ""
            ]
          },
          " ",
          {
            "if": [
              "$subjectFederation",
              "$subjectFederation",
              ""
            ]
          },
          {
            "if": [
              "$federationBorough",
              {
                "concat": [
                  ", ",
                  "$federationBorough"
                ]
              },
              ""
            ]
          },
          {
            "if": [
              {
                "and": [
                  {
                    "ne": [
                      "$subjectFederation",
                      "Санкт-Петербург г"
                    ]
                  },
                  {
                    "ne": [
                      "$subjectFederation",
                      "Москва г"
                    ]
                  }
                ]
              },
              {
                "concat": [
                  ", ",
                  "$town"
                ]
              },
              ""
            ]
          },
          {
            "if": [
              "$street",
              {
                "concat": [
                  ", ",
                  "$street"
                ]
              },
              ""
            ]
          },
          {
            "if": [
              "$houseNumber",
              {
                "concat": [
                  ", Дом ",
                  "$houseNumber"
                ]
              },
              ""
            ]
          },
          {
            "if": [
              "$flatNumber",
              {
                "concat": [
                  ", Квартира (офис) ",
                  "$flatNumber"
                ]
              },
              ""
            ]
          }
        ]
      }
    },

```
**Результат:** _вывод адреса с пробелами и запятыми между значениями атрибутов_


### Поддерживаемые функции:

`eq` - равно

`ne` - не равно

`lt` - меньше

`gt` - больше

`lte` - меньше либо равно

`gte` - больше, либо равно


`and` - и

`or` - или

`not` - не

`add` - арифметическое сложение

`sub` - арифметическое вычитание

`mul` - арифметическое умножение

`div` - арифметическое деление

`nempty` - не пусто

`empty` - пусто

`pad` - дополнение строки символами до нужной длины

`next` - 

`merge` - конкатенация атрибутов в коллекции

`size` - принимает в качестве аргумента атрибуты типа строка и коллекция. Для строк возвращает длину, для коллекций - количество элементов.

`element` - получение произвольного элемента из массива, индексирование с 0 ([массив значений], [индекс элемента: 0 - первый элемент, last - последний элемент])

`dateAdd` - добавление к дате (в нотации momentjs - [Дата], [добавляемый интервал (число)], [ед.изм (строка [d, m, y, h, min, s, ms)])

`dateDiff` - разница между датами (в нотации momentjs - [ед.изм], [Дата1], [Дата2])

`now` - текущая дата-время

`concat` - конкатенация строк
```
substring - получение подстроки ([Строка], [ с какого символа], [сколько символов])
```

`obj` - формирование объекта, нечетные аргументы - имена свойств, четные - значения

агрегация:

`max`, `min`, `avg`, `sum`, `count`

Все функции агрегации принимают следующие аргументы:

либо

```
[$Имя атрибута коллекции], [Имя агрегируемого атрибута], [функция фильтрации элементов коллекции]
```

либо

```
[Имя класса], [Имя агрегируемого атрибута], [Объект фильтра сформированный функцией obj соответствующий нотации фильтров mongodb]
```

`1` - указывает на уникальность объекта, то есть позволяет для функций агрегации производить подсчет только по уникальным объектам.

`\n` - перенос на другую строку

### Пример:

```
"formula": {
        "merge": [
          "$atr1",
          "atr2.name",
          null,
          1,
          "\n"
        ]
      },

```



## Описание принципа формирования формул (TODO)

Открывается объект в котором вызывается операция по получению результатов формул, асинхронно. Когда результаты получены они записываются в атрибуты.  
Как результат получается класс.

1. Проверяем поля класса. Если у класса есть формула и поля не являются `eval()`, то асинхронно вызываем вычисление. Если формула и `eval()`, то записываем атрибут.

2. Ожидаем выполнения вычисления формул, записываем результат атрибут formulaRes для исходного объекта. Начинаем выполнения `eval()` формул. 

## Автоприсвоение и получение значения атрибута в вычисляемом выражении

1. Чтобы вычисляемое выражение не выполнялось при открытии формы создания, у атрибута надо выставить `autoassigned: true`. Тогда выражения будут вычислены непосредственно перед сохранением объекта. Это актуально при использовании функции `next` в вычислениях, так как не всегда необходимо извлекать очередное значение последовательности при каждом открытии формы создания.

2. Значения по умолчанию рассчитываются до записи объекта в БД, то есть на этапе их вычисления в простых автоприсваемых атрибутах еще ничего нет.

3. Функция `next($id)` (если в `$id` задано значение) будет всегда возвращать 1, так как для каждого объекта будет создаваться отдельная последовательность, из которой выбирается только первое значение.

### Следующая страница: [Кеширование значения вычислимого атрибута](/docs/ru/2_system_description/metadata_structure/meta_class/atr_cached_true.md)    
--------------------------------------------------------------------------  


 #### [Licence](/LICENCE.md) &ensp;  [Contact us](https://iondv.com) &ensp;  [English](/docs/en/2_system_description/metadata_structure/meta_class/atr_formula.md)   &ensp; [FAQs](/faqs.md)          



--------------------------------------------------------------------------  

Copyright (c) 2018 **LLC "ION DV"**.
All rights reserved. 