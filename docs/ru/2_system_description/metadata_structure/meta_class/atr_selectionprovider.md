### Предыдущая страница []()

# Список выбора допустимых значений

Задает список выбора допустимых значений для поля ввода атрибута.  
Поле атрибутивной части меты класса - ` "selectionProvider"` (объект).   
Есть три типа списка выбора, тип задается в поле (`"type"`) одной из следующих ключевых фраз: 

* `"SIMPLE"` - список выбора простого типа, 
* `"MATRIX"` - список выбора матричного типа, 
* `"HQL"` - список выбора типа запрос (**не реализовано**)

## Описание полей структуры

### Структура объекта списка выбора

```
      "selectionProvider": {
        "type": "SIMPLE",
        "list": [...],
        "matrix": [],
        "parameters": [],
        "hq": ""
      },
```

| Поле           | Наименование в студии | Допустимые значения                                                                                                 | Описание                                             |
|:---------------|:----------------------|:--------------------------------------------------------------------------------------------------------------------|:-----------------------------------------------------|
| `"type"`       | **Тип**               | ` "SIMPLE", "MATRIX", "HQL"`                                                                                        | Тип списка выбора                                    |
| `"list"`       | **Простой тип**       | Массив объектов типа "ключ-значение".                                                                               | Список выбора просто типа ("SIMPLE") хранится здесь. |
| `"matrix"`     | **Матрица**           | Массив векторов, каждый из которых состоит из именования, комплекта условий выбора и комплекта пар "ключ-значение". | Список выбора матричного типа ("MATRIX").            |
| `"parameters"` | **Параметры запроса** | Массив объектов типа "ключ-значение".                                                                               | Параметры запроса, **не реализовано**                |
| `"hq"`         | **Запрос**            | Строка запроса в соответствии с форматом обработчика                                                                | Строка запроса, **не реализовано**                   |

### Поле `"list"` - массив объектов следующей структуры

```
        "list": [
          {
            "key": "2001-03-23 09:00:00.000Z",
            "value": "Затопление орбитальной станции «Мир» (23 марта 2001 г. 09:00 мск)"
          },
          {
            "key": "1957-10-04 19:28:00.000Z",
            "value": "Запуск первого в мире искусственного спутника (4 октября 1957 г. в 19:28 гринвич)"
          },
          {
            "key": "1970-04-17 12:07:00.000Z",
            "value": "Завершение полёта «Аполлон-13» (17 апреля 1970 г. 12:07 Хьюстон)"
          }
        ],
```

| Поле      | Наименование в студии | Допустимые значения                                                                     | Описание                                                         |
|:----------|:----------------------|:----------------------------------------------------------------------------------------|:-----------------------------------------------------------------|
| `"key"`   | **Ключ**              | Любое значение, соответствующее типу атрибута для которого заведен данный список выбора | При сохранении объекта именно значение ключа записывается в базу |
| `"value"` | **Значение**          | Любая строка, могут быть проблемы при наличии управляющих последовательностей           | Значение этого поля выводится в пользовательском интерфейсе      |

### Поле `"matrix"` - массив объектов следующей структуры

```
        "matrix": [
          {
            "comment": "Оба отрицательные",
            "conditions": [
              {
                "property": "matrix_base_1",
                "operation": 5,
                "value": "0",
                "nestedConditions": []
              },
              {
                "property": "matrix_base_2",
                "operation": 5,
                "value": "0",
                "nestedConditions": []
              }
            ],
            "result": [
              {
                "key": "Оба отрицательные",
                "value": "Оба отрицательные"
              }
            ]
          },
          {
            "comment": "Оба неотрицательные",
            "conditions": [
              {
                "property": "matrix_base_1",
                "operation": 8,
                "value": "0",
                "nestedConditions": []
              },
              {
                "property": "matrix_base_2",
                "operation": 8,
                "value": "0",
                "nestedConditions": []
              }
            ],
            "result": [
              {
                "key": "Оба неотрицательные",
                "value": "Оба неотрицательные"
              }
            ]
          },
          {
            "comment": "Первое неотрицательное второе отрицательное",
            "conditions": [
              {
                "property": "matrix_base_1",
                "operation": 8,
                "value": "0",
                "nestedConditions": []
              },
              {
                "property": "matrix_base_2",
                "operation": 5,
                "value": "0",
                "nestedConditions": []
              }
            ],
            "result": [
              {
                "key": "Первое неотрицательное второе отрицательное",
                "value": "Первое неотрицательное второе отрицательное"
              }
            ]
          },
          {
            "comment": "Первое отрицательное, второе неотрицательное",
            "conditions": [
              {
                "property": "matrix_base_1",
                "operation": 5,
                "value": "0",
                "nestedConditions": []
              },
              {
                "property": "matrix_base_2",
                "operation": 8,
                "value": "0",
                "nestedConditions": []
              }
            ],
            "result": [
              {
                "key": "Первое отрицательное, второе неотрицательное",
                "value": "Первое отрицательное, второе неотрицательное"
              }
            ]
          }
        ],
        "parameters": [],
        "hq": ""
      },
```

Каждый объект массива `"MATRIX"` содержит следующие обязательные поля:

| Поле           | Наименование в студии | Допустимые значения                                 | Описание                                                                                                       |
|:---------------|:----------------------|:----------------------------------------------------|:---------------------------------------------------------------------------------------------------------------|
| `"comment"`    | **Комментарий**       | Любая строка                                        | Комментарий к вектору, наименование вектора в студии                                                           |
| `"conditions"` | **Условия**           | Массив объектов                                     | Определяет условия при которых выводится список элементов описанный в  `"result"` данного вектора              |
| `"result"`     | **Результаты**        | Массив объектов, аналогичен структуре поля `"list"` | Задает список выбора, который выводится при соблюдении условий, перечисленных в `"conditions"` данного вектора |

В нотации студии данная структура называются **"Вектор"**.

#### Поле `"conditions"` векторов матрицы

| Поле                 | Наименование в студии        | Допустимые значения                                                   | Описание                                                                                           |
|:---------------------|:-----------------------------|:----------------------------------------------------------------------|:---------------------------------------------------------------------------------------------------|
| `"property"`         | **Атрибут**                  | Строка, только латиница без пробелов                                  | Атрибут класса, значение поля которого проверяется на соответствие данному условию данного вектора |
| `"operation"`        | **Операция**                 | Код операции                                                          | Операция, согласно которой производится определение                                                |
|                      |                              | _0 - равно (И)_                                                       |                                                                                                    |
|                      |                              | _1 - не равно (ИЛИ)_                                                  |                                                                                                    |
|                      |                              | _2 - пусто (НЕ)_                                                      |                                                                                                    |
|                      |                              | _3 - не пусто (МИН ИЗ)_                                               |                                                                                                    |
|                      |                              | _4 - (МАКС ИЗ)_                                                       |                                                                                                    |
|                      |                              | _5 - < ()_                                                            |                                                                                                    |
|                      |                              | _6 - >_                                                               |                                                                                                    |
|                      |                              | _7 - <=_                                                              |                                                                                                    |
|                      |                              | _8 - >=_                                                              |                                                                                                    |
|                      |                              | _9 - IN /Похож/_                                                                   |                                                                                                    |
|                      |                              | _10 - содержит_                                                       |                                                                                                    |
| `"value"`            | **Значение**                 | Зависит от типа операции                                              | Второе значение для бинарных операций                                                              |
| `"nestedConditions"` | **Вложенные условия отбора** | Объект, структура аналогична структуре самого объекта условий отбора. |                                                                                                    |

_NB: Код операции соответствует разным значениям операций, в зависимостри от того, выбран у нас атрибут или нет. Если поле  `"property"` равно `null`, то кодируется логическое условие, по которому объединяются вложенные условия отбора! (Указаны в скобках в таблице выше)_

## Описание

### Для простого списка выбора  

Фактически, данный список выбора позволяет создать жестко зашитый в приложении пресет значений поля, ограничив тем самом выбор пользователя.  
Для поля в обязательном порядке следует задать тип представления - "Выпадающий список [5]".  
Подразумевает возможность сохранять данные в базе в типе, отличном от типа данных, выводимых пользователю.  
_Например_: Если мы зададим  в качестве полей `key` элементов списка выбора значения даты-времени в ISODate, а в качестве `value` - описание события, то предоставим пользвателю возможность выбрать событие, но внутри приложения работать с данными типа ISODate.

_NB: Если у атрибута со списком выбора разрешено пустое значение: `"nullable": true` - в списке выбора добавляется пустое значение, выставляемое по умолчанию!_

```
    {
      "orderNumber": 50,
      "name": "sp_date",
      "caption": "Сохраняем ключ дата-время",
      "type": 9,
      "size": null,
      "decimals": 0,
      "allowedFileTypes": null,
      "maxFileCount": 0,
      "nullable": true,
      "readonly": false,
      "indexed": false,
      "unique": false,
      "autoassigned": false,
      "hint": null,
      "defaultValue": null,
      "refClass": "",
      "itemsClass": "",
      "backRef": "",
      "backColl": "",
      "binding": "",
      "semantic": null,
      "selConditions": [],
      "selSorting": [],
      "selectionProvider": {
        "type": "SIMPLE",
        "list": [
          {
            "key": "2001-03-23T09:00:00.000Z",
            "value": "Затопление орбитальной станции «Мир» (23 марта 2001 г. 09:00 мск)"
          },
          {
            "key": "1957-10-04T19:28:00.000Z",
            "value": "Запуск первого в мире искусственного спутника (4 октября 1957 г. в 19:28 гринвич)"
          },
          {
            "key": "1970-04-17T12:07:00.000Z",
            "value": "Завершение полёта «Аполлон-13» (17 апреля 1970 г. 12:07 Хьюстон)"
          }
        ],
        "matrix": [],
        "parameters": [],
        "hq": ""
      },
      "indexSearch": false,
      "eagerLoading": false,
      "formula": null
    }
```

Создание данного списка выбора не представляет сложности:

1. выбираем исходя из требований предметной области наиболее удобный тип атрибута,
2. выбираем идентификаторы данного типа (`"key"`) с той целью, что бы при необходимости автоматизированной обработки оперировать значениями в базе максимально эффективно,
3. задаем к каждому идентификатору подпись, которая будет отображаться в интерфейсе `"value"`,
4. в представлениях тип представления - "Выпадающий список [5]" в обязательном порядке.

### Для списка выбора типа "MATRIX"  

Создание списков выбора данного типа требует особой внимательности разработчика.  
В матрицах результирующий список выбора - все, что подпадает под условия. Если условий нет - то считаем, что список выбора применяется всегда.
Для абсолютной предсказуемости работы приложения, нужно соблюсти два условия:

1. Вектора не должны перекрывать друг друга.
2. Массив значений опорного атрибута - основания матрицы (массив сочетаний значений опорных атрибутов) должен полностью закрываться описанными векторами.

#### Почему так?  

1. Система берет значение опорного поля (полей) и последовательно применяет к нему условия описанные в векторах.  
   Каждый вектор - это набор условий и собственный список выбора. Как только система дойдет до вектора, условиям которого удовлетворяет значение опорного поля, она берет из него список выбора и определяет к выводу в пользовательском интерфейсе.  
   Так что ситуация: "ой, а тут надо было по другому условию выводить", это не проблема ядра, а проблема разработки векторов списка выбора.

2. Подразумевается, что на любое значение опорного поля система найдет соответствующий вектор.  
   Если не найдет - то выведет "что-нибудь" и "как-нибудь", так что надо что бы нашла и думать об этом тому, кто разрабатывает список выбора.  

Еще имеет смысл уточнить, что операции выполняются согласно js, так что про null, undefined и NaN необходимо хотя бы помнить.

#### Пример 1: Матрица от двух целочисленных значений

**JSON класса**:

```
{
  "isStruct": false,
  "key": [
    "id"
  ],
  "semantic": "",
  "name": "selection_provider_matrix_dc",
  "version": "",
  "caption": "\"MATRIX\" от двух оснований",
  "ancestor": null,
  "container": null,
  "creationTracker": "",
  "changeTracker": "",
  "history": 0,
  "journaling": false,
  "compositeIndexes": [],
  "properties": [
    {
      "orderNumber": 10,
      "name": "id",
      "caption": "Идентификатор",
      "type": 12,
      "size": null,
      "decimals": 0,
      "allowedFileTypes": null,
      "maxFileCount": 0,
      "nullable": false,
      "readonly": false,
      "indexed": false,
      "unique": true,
      "autoassigned": true,
      "hint": null,
      "defaultValue": null,
      "refClass": "",
      "itemsClass": "",
      "backRef": "",
      "backColl": "",
      "binding": "",
      "semantic": null,
      "selConditions": [],
      "selSorting": [],
      "selectionProvider": null,
      "indexSearch": false,
      "eagerLoading": false,
      "formula": null
    },
    {
      "orderNumber": 20,
      "name": "matrix_base_1",
      "caption": "Первое целое основание матрицы",
      "type": 6,
      "size": null,
      "decimals": 0,
      "allowedFileTypes": null,
      "maxFileCount": 0,
      "nullable": true,
      "readonly": false,
      "indexed": false,
      "unique": false,
      "autoassigned": false,
      "hint": null,
      "defaultValue": null,
      "refClass": "",
      "itemsClass": "",
      "backRef": "",
      "backColl": "",
      "binding": "",
      "semantic": null,
      "selConditions": [],
      "selSorting": [],
      "selectionProvider": null,
      "indexSearch": false,
      "eagerLoading": false,
      "formula": null
    },
    {
      "orderNumber": 30,
      "name": "matrix_base_2",
      "caption": "Второе целое основание матрицы",
      "type": 6,
      "size": null,
      "decimals": 0,
      "allowedFileTypes": null,
      "maxFileCount": 0,
      "nullable": true,
      "readonly": false,
      "indexed": false,
      "unique": false,
      "autoassigned": false,
      "hint": null,
      "defaultValue": null,
      "refClass": "",
      "itemsClass": "",
      "backRef": "",
      "backColl": "",
      "binding": "",
      "semantic": null,
      "selConditions": [],
      "selSorting": [],
      "selectionProvider": null,
      "indexSearch": false,
      "eagerLoading": false,
      "formula": null
    },
    {
      "orderNumber": 40,
      "name": "selection_provider_matrix",
      "caption": "Список выбора типа \"MATRIX\"",
      "type": 0,
      "size": null,
      "decimals": 0,
      "allowedFileTypes": null,
      "maxFileCount": 0,
      "nullable": true,
      "readonly": false,
      "indexed": false,
      "unique": false,
      "autoassigned": false,
      "hint": null,
      "defaultValue": null,
      "refClass": "",
      "itemsClass": "",
      "backRef": "",
      "backColl": "",
      "binding": "",
      "semantic": null,
      "selConditions": [],
      "selSorting": [],
      "selectionProvider": {
        "type": "MATRIX",
        "list": [],
        "matrix": [
          {
            "comment": "Оба отрицательные",
            "conditions": [
              {
                "property": "matrix_base_1",
                "operation": 5,
                "value": "0",
                "nestedConditions": []
              },
              {
                "property": "matrix_base_2",
                "operation": 5,
                "value": "0",
                "nestedConditions": []
              }
            ],
            "result": [
              {
                "key": "Оба отрицательные",
                "value": "Оба отрицательные"
              }
            ]
          },
          {
            "comment": "Оба неотрицательные",
            "conditions": [
              {
                "property": "matrix_base_1",
                "operation": 8,
                "value": "0",
                "nestedConditions": []
              },
              {
                "property": "matrix_base_2",
                "operation": 8,
                "value": "0",
                "nestedConditions": []
              }
            ],
            "result": [
              {
                "key": "Оба неотрицательные",
                "value": "Оба неотрицательные"
              }
            ]
          },
          {
            "comment": "Первое неотрицательное второе отрицательное",
            "conditions": [
              {
                "property": "matrix_base_1",
                "operation": 8,
                "value": "0",
                "nestedConditions": []
              },
              {
                "property": "matrix_base_2",
                "operation": 5,
                "value": "0",
                "nestedConditions": []
              }
            ],
            "result": [
              {
                "key": "Первое неотрицательное второе отрицательное",
                "value": "Первое неотрицательное второе отрицательное"
              }
            ]
          },
          {
            "comment": "Первое отрицательное, второе неотрицательное",
            "conditions": [
              {
                "property": "matrix_base_1",
                "operation": 5,
                "value": "0",
                "nestedConditions": []
              },
              {
                "property": "matrix_base_2",
                "operation": 8,
                "value": "0",
                "nestedConditions": []
              }
            ],
            "result": [
              {
                "key": "Первое отрицательное, второе неотрицательное",
                "value": "Первое отрицательное, второе неотрицательное"
              }
            ]
          }
        ],
        "parameters": [],
        "hq": ""
      },
      "indexSearch": false,
      "eagerLoading": false,
      "formula": null
    }
  ]
}
```

**Класс в мете ДнТ**: http://dev.dnt.local/registry/develop-and-test@attr_class_fields.selection_provider.matrix.dc    

**Описание и порядок разработки**:  

Итак, у нас есть два целочисленных атрибута: `"matrix_base_1"` и `"matrix_base_2"`.  
Нам нужно разделить все возможные сочетания пар атрибутов на 4 вектора. Будем делить относительно нуля, то есть каждое поле у нас может быть либо отрицательным, либо неотрицательным. Не смотря на кажущуюся простоту задачи, что бы корректно определить условия, пришлось создать вот такую схему:

![Разбиваем на вектора](images/matrix-dc.jpg)

И уже потом выписывать вектора и их условия:

1. Оба отрицательные: (matrix_base_1 < 0) && (matrix_base_2 < 0)
2. Оба неотрицательные: (matrix_base_1 >= 0) && (matrix_base_2 >= 0)
3. Первое неотрицательное второе отрицательное: (matrix_base_1 >= 0) && (matrix_base_2 < 0)
4. Первое отрицательное, второе неотрицательное: (matrix_base_1 < 0) && (matrix_base_2 >= 0)

Если в 3 и 4 условиях перепутать где у нас равенство нулю - получим выпадающие элементы и перекрытие векторов.  

В данном классе для каждого вектора список выбора ограничен одним пунктом, их число может быть много большим.

#### Пример 2: Матрица от свободного действительного значения со сложными условиями

**Вектора и их условия**:

1. matrix_base < 3 
2. matrix_base = 3
3. (matrix_base > 3) && (matrix_base <= 15)
4. matrix_base >= 16  
   _Уупс, потеряли кусок между 15 и 16, у нас действительные, а не целые значения!_
5. (matrix_base < 15) && (matrix_base > 16)

**Класс в мете ДнТ**: http://dev.dnt.local/registry/develop-and-test@attr_class_fields.selection_provider.matrix.real  
**Мета класса**: https://git.iondv.ru/ION-APP/develop-and-test/blob/raw/meta/selection_provider_matrix_real.class.json  

#### Дополнительные примеры в мете ДнТ

http://dev.dnt.local/registry/develop-and-test@attr_class_fields.selection_provider.matrix.empty  
http://dev.dnt.local/registry/develop-and-test@attr_class_fields.selection_provider.matrix.contain  
http://dev.dnt.local/registry/develop-and-test@attr_class_fields.selection_provider.matrix.not_equal  
http://dev.dnt.local/registry/develop-and-test@attr_class_fields.selection_provider.matrix.equal  

## Важно

Выявленные проблемы в работе списков выбора 1 и 2 типа: https://ion-dv.atlassian.net/browse/MODREGISTR-72  
По списку выбора типа запрос: https://ion-dv.atlassian.net/browse/MODREGISTR-58  

### Следующая страница []()
--------------------------------------------------------------------------  


 #### [Licence](/LICENCE.md) &ensp;  [Contact us](https://iondv.com) &ensp;  [English](/README.md)   &ensp; [FAQs](/faqs.md)          



--------------------------------------------------------------------------  

Copyright (c) 2018 **LLC "ION DV"**.
All rights reserved. 